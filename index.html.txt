<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO Optimization: Updated Title for better search engine visibility -->
    <title>Stream Free Movies & TV Shows in HD - Watch Online on Putlocker US</title>
    <!-- Favicon: Using SVG emoji for the movie icon. More concise and no external files needed. -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé¨</text></svg>">

    <!-- SEO Optimization: Updated Description and Keywords for better search engine indexing -->
    <meta name="description" content="Putlocker US: Stream and download the latest movies & TV series in Full HD for free! Enjoy unlimited entertainment without registration. Watch blockbuster films, trending shows, and classic cinema online now!">
    <meta name="keywords" content="free movies online, watch movies free, HD streaming, watch TV series, latest movies, download movies, no sign-up, free entertainment, online movie site, Putlocker US, stream films, full HD, movie streaming, TV show streaming">

    <!-- Open Graph Meta Tags for social media sharing - Updated with new title and description -->
    <meta property="og:title" content="Putlocker US: Stream Free Movies & TV Shows in HD">
    <meta property="og:description" content="Putlocker US: Stream and download the latest movies & TV series in Full HD for free! Enjoy unlimited entertainment without registration. Watch blockbuster films, trending shows, and classic cinema online now!">
    <!-- Updated: Using new image URL -->
    <meta property="og:image" content="https://live.staticflickr.com/65535/54680969764_a119fe1f10_b.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://putlocker-us.pages.dev/"> <!-- Updated to reflect potential new Cloudflare Pages URL -->
    <meta property="og:type" content="website">
    <meta property="fb:app_id" content="100081831755621">

    <!-- Twitter Card Meta Tags - Updated with new title and description -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@erick_yoha46813"> <!-- Updated with new Twitter handle -->
    <meta name="twitter:title" content="Putlocker US: Stream Free Movies & TV Shows in HD">
    <meta name="twitter:description" content="Putlocker US: Stream and download the latest movies & TV series in Full HD for free! Enjoy unlimited entertainment without registration. Watch blockbuster films, trending shows, and classic cinema online now!">
    <meta name="twitter:image" content="https://live.staticflickr.com/65535/54680969764_a119fe1f10_b.jpg">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Base styling for HTML and body */
        html, body {
            height: 100%;
            min-height: 100vh;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            background-color: #1a202c;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Roboto', sans-serif;
            box-sizing: border-box; /* Apply border-box globally */
        }
        
        /* Ensures the custom header remains fixed and sets its internal layout */
        header {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            max-width: 1280px; /* Limits header width */
            z-index: 50; /* Ensures it's above other content */
            background-color: #1a202c;
            box-sizing: border-box; /* Ensures padding doesn't increase width */
            display: flex; /* Uses flexbox for internal layout */
            flex-direction: column; /* Stacks header content vertically */
            padding-bottom: 0;
            padding-top: 1.25rem; /* Top padding for header top part */
        }

        /* Styles for the genre buttons container (now part of the header) */
        .genre-buttons-container {
            width: 100%;
            background-color: #1a202c; /* Matches main header background color */
            padding: 1rem; /* p-4 */
            border-top: 1px solid rgba(255, 255, 255, 0.1); /* Visual separation line */
        }
        /* Ensures main content starts right after the header */
        main {
            margin-top: 0;
            padding-top: 0;
            max-width: 1280px; /* Max width so content isn't too wide on desktop */
            width: 100%; /* Ensures main content takes full available width within max-width */
            margin-left: auto;
            margin-right: auto;
        }

        /* Adjust font size and padding for nav button to match genre button */
        .nav-button {
            font-size: 0.875rem; /* text-sm */
            padding-left: 1rem; /* px-4 */
            padding-right: 1rem; /* px-4 */
            padding-top: 0.5rem; /* py-2 */
            padding-bottom: 0.5rem; /* py-2 */
        }
        /* Adjust font size for medium and up screens to remain large like genre button */
        @media (min-width: 768px) {
            .nav-button {
                font-size: 1rem; /* md:text-base */
            }
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; /* bg-gray-800 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* bg-gray-600 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }

        /* Hide elements by default for layers */
        .layer-2, .layer-3, .layer-4 { /* Added .layer-4 */
            display: none;
        }

        /* Ensures iframe fills its container responsively */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.5rem; /* rounded-lg */
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* Basic spinner for loading */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #f97316; /* Orange-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Rainbow text style */
        .rainbow-text {
            background-image: linear-gradient(to right, violet, indigo, blue, green, yellow, orange, red);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent; /* Makes text color transparent for gradient to show */
            display: inline-block; /* Important for background-clip to work correctly */
        }

        /* FIX: Ensures detail title is visible */
        #detail-title {
            display: block;
            visibility: visible;
            height: auto;
            font-size: 2.25rem; /* Example: Keeps tailwind h2 text size */
            line-height: normal;
            margin: 0 0 0.5rem 0; /* Adjust margin as needed */
        }

        /* Style for static movie cards in Layer 3 */
        .static-movie-card {
            background-color: #1f2937; /* bg-gray-800 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            overflow: hidden;
            transform: scale(1);
            transition: all 0.3s ease-in-out; /* transition-all duration-300 */
            cursor: pointer;
        }

        .static-movie-card:hover {
            transform: scale(1.05); /* hover:scale-105 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* hover:shadow-xl */
        }

        .static-movie-card img {
            width: 100%;
            height: auto;
            object-fit: cover;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }

        .static-movie-card .info {
            padding: 1rem; /* p-4 */
            text-align: center; /* Changed to center */
        }

        .static-movie-card h3 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            color: #f9fafb; /* text-gray-100 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }

        .static-movie-card p {
            font-size: 0.875rem; /* text-sm */
            color: #9ca3af; /* text-gray-400 */
        }

        /* CSS to remove underline from home logo link */
        #home-logo-link {
            text-decoration: none; /* Removes default underline */
        }
        #home-logo-link:hover {
            text-decoration: none; /* Ensures no underline on hover */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex flex-col">

    <!-- Header (Fixed) - Now integrated with genre buttons -->
    <header class="sticky top-0 z-50 bg-gray-900 shadow-lg px-4 md:px-8 flex flex-col items-center rounded-b-lg">
        <!-- Header Top Part: Logo, Navigation and Search -->
        <div class="flex flex-col sm:flex-row items-center justify-between w-full py-4">
            <div class="flex items-center mb-4 sm:mb-0">
                <!-- Logo (simple text) - Now wrapped in an anchor tag to act as a Home button -->
                <a href="#" id="home-logo-link" class="inline-flex items-center text-indigo-500 hover:text-indigo-400 transition-colors duration-200">
                <span class="text-3xl font-bold mr-2">üé¨</span>
                <!-- SEO Optimization: Changed app title to "Putlocker US" for uniqueness and SEO friendliness -->
                <h1 class="text-4xl font-bold whitespace-nowrap rainbow-text" data-lang-key="appTitle">Putlocker US</h1>
                </a>
            </div>
            <nav class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-6 w-full sm:w-auto">
                <div class="flex w-full sm:w-auto sm:space-x-6">
                    <button id="nav-home-button" class="nav-button bg-gray-800 hover:bg-purple-600 rounded-md text-gray-100 font-medium w-full sm:w-auto text-sm md:text-base transition-all duration-200" data-lang-key="homeButton">Home</button>
                    <button id="nav-movies-button" class="nav-button bg-gray-800 hover:bg-blue-600 rounded-md text-gray-100 font-medium w-full sm:w-auto text-sm md:text-base transition-all duration-200" data-lang-key="moviesButton">Movies</button>
                    <button id="nav-tvseries-button" class="nav-button bg-gray-800 hover:bg-rose-600 rounded-md text-gray-100 font-medium w-full sm:w-auto text-sm md:text-base transition-all duration-200" data-lang-key="tvSeriesButton">TV Series</button>
                </div>
                <div class="relative w-full sm:w-64">
                    <input type="text" id="search-input" data-lang-key="searchMoviesPlaceholder" placeholder="Search movies..." class="w-full bg-gray-700 text-gray-200 placeholder-gray-400 py-2 pl-4 pr-10 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200">
                    <button id="search-button" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-200 transition-colors duration-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </button>
                </div>
            </nav>
        </div>
        <!-- Header Bottom Part: Genre Filter Buttons -->
        <div class="genre-buttons-container p-4 shadow-md flex flex-wrap justify-center gap-3 rounded-b-lg">
            <!-- Genre buttons will be injected here by JS -->
        </div>
    </header>

    <main class="flex-grow mx-auto px-4 py-8">
        <!-- Layer 1: Movie/TV Thumbnails -->
        <section id="layer-1" class="layer-1">
            <!-- SEO Optimization: Changed section title to reflect content better -->
            <h2 class="text-4xl font-bold text-gray-100 mb-8 text-center"><span id="section-title" data-lang-key="popularMovies">Popular Movies & TV Shows Streaming Now</span></h2>
            <div id="movie-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 min-h-[500px]">
                <!-- Movie/TV thumbnails will be loaded here by JS -->
            </div>
            <div class="flex justify-center mt-10">
                <!-- Load More Button -->
                <button id="load-more-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-lang-key="loadMoreButton">
                    Load More
                </button>
            </div>
            <!-- Loading spinner for Layer 1 -->
            <div id="loading-spinner-layer1" class="hidden flex justify-center items-center py-8">
                <div class="spinner"></div>
            </div>
            <p id="no-results-message" class="hidden text-center text-gray-400 text-lg mt-8" data-lang-key="noResultsFound">No results found for your search.</p>
        </section>

        <!-- Layer 2: Movie/TV Detail -->
        <section id="layer-2" class="layer-2 bg-gray-800 p-6 md:p-8 rounded-lg shadow-xl relative">
            <button id="back-to-list-button" class="absolute top-4 left-4 bg-gray-700 hover:bg-gray-600 text-gray-200 p-2 rounded-full shadow-md transition-colors duration-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            </button>
            <!-- Loading spinner for Layer 2 -->
            <div id="loading-spinner-layer2" class="flex justify-center items-center h-96">
                <div class="spinner"></div>
            </div>
            <div id="movie-detail-content" class="hidden">
                <div class="flex flex-col md:flex-row gap-8 mb-8">
                    <!-- SEO Optimization: Added alt attribute to image for better accessibility and SEO -->
                    <img id="detail-poster" src="" alt="Movie or TV Show Poster" class="w-full md:w-1/3 lg:w-1/4 rounded-lg shadow-md object-cover">
                    <div class="flex-1">
                        <!-- SEO Optimization: Dynamic title for detail page, important for specific movie/show SEO -->
                        <h2 id="detail-title" class="text-4xl font-bold text-gray-100 mb-2"></h2>
                        <p id="detail-genre" class="text-gray-400 mb-2"></p>
                        <p id="detail-rating" class="text-yellow-500 font-semibold text-lg mb-4">‚≠ê </p>
                        <!-- New detail fields -->
                        <p id="detail-year" class="text-gray-300 text-sm mb-1" data-lang-prefix="productionYearPrefix">Production Year: </p>
                        <p id="detail-aka" class="text-gray-300 text-sm mb-1" data-lang-prefix="akaPrefix">Also Known As: </p>
                        <p id="detail-age-rating" class="text-gray-300 text-sm mb-1" data-lang-prefix="ageRatingPrefix">Age Rating: </p>
                        <p id="detail-director" class="text-gray-300 text-sm mb-4" data-lang-prefix="directorPrefix">Director: </p>
                        <p id="detail-cast" class="text-gray-300 text-sm mb-4" data-lang-prefix="castPrefix">Cast: </p>
                        <!-- SEO Optimization: Plot summary is crucial content for search engines -->
                        <p id="detail-plot" class="text-gray-200 leading-relaxed mb-6 text-justify"></p>
                        
                        <!-- New AI-Powered Feature: Why Watch This? -->
                        <button id="why-watch-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 mt-4 flex items-center justify-center">
                            <!-- Inline SVG for sparkle icon to avoid external file issues -->
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1.447l.823.412a1 1 0 00.974-.197l1.243-.932a1 1 0 011.532 1.29l-.622 1.556a1 1 0 00.322 1.13l1.109.916a1 1 0 01.002 1.618l-1.109.916a1 1 0 00-.322 1.13l.622 1.556a1 1 0 01-1.532 1.29l-1.243-.932a1 1 0 00-.974-.197L11 17.553V19a1 1 0 01-2 0v-1.447l-.823-.412a1 1 0 00-.974.197l-1.243.932a1 1 0 01-1.532-1.29l.622-1.556a1 1 0 00-.322-1.13l-1.109-.916a1 1 0 01-.002-1.618l1.109-.916a1 1 0 00.322-1.13l-.622-1.556a1 1 0 011.532-1.29l1.243.932a1 1 0 00.974.197L9 2.447V3a1 1 0 011-1z" clip-rule="evenodd"></path>
                            </svg>
                            <span data-lang-key="whyWatchButtonText">Why Watch This?</span>
                        </button>
                        <div id="why-watch-output" class="bg-gray-700 p-4 rounded-md mt-4 text-gray-200 hidden">
                            <p class="font-semibold text-lg mb-2" data-lang-key="insightTitle">Insight from Putlocker US:</p>
                            <p id="why-watch-text" class="text-sm"></p>
                            <div id="why-watch-spinner" class="spinner hidden mt-4 mx-auto"></div>
                        </div>
                    </div>
                </div>

                <div class="video-container mb-8">
                    <iframe id="detail-trailer" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>

                <div class="flex flex-wrap justify-center gap-4">
                    <!-- Stream 1 Button (vidsrc.me) -->
                    <button id="stream-1-button" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 px-8 rounded-lg shadow-xl transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-rose-500" data-lang-key="stream1Button">
                        Stream 1
                    </button>
                    <!-- Stream 2 Button (vidsrc.to) -->
                    <button id="stream-2-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-xl transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-lang-key="stream2Button">
                        Stream 2
                    </button>
                </div>

                <!-- Top Rated Movies section for Layer 2 -->
                <div class="mt-8 text-center">
                    <h3 class="text-xl font-bold text-gray-100 mb-4" data-lang-key="topRatedMovies">Top Rated Movies:</h3>
                    <div id="top-rated-movie-grid-layer2" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                        <!-- Top Rated Movies will be dynamically loaded here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Layer 3: Streaming Player -->
        <section id="layer-3" class="layer-3 bg-gray-900 p-4 md:p-8 rounded-lg shadow-xl flex flex-col">
            <button id="back-to-detail-button" class="bg-gray-700 hover:bg-gray-600 text-gray-200 p-2 rounded-full shadow-md mb-4 self-start transition-colors duration-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            </button>
            <!-- Loading spinner for Layer 3 -->
            <div id="loading-spinner-layer3" class="flex justify-center items-center flex-grow">
                <div class="spinner"></div>
            </div>
            <div class="flex-grow video-container" id="streaming-player-container">
                <iframe id="streaming-player" src="" frameborder="0" allowfullscreen class="rounded-lg"></iframe>
            </div>
            <!-- Direct streaming buttons added -->
            <div class="flex flex-wrap justify-center gap-4 mt-6">
                <button id="stream-3-button" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 px-8 rounded-lg shadow-xl transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-rose-500" data-lang-key="stream3Button">
                    Stream 3
                </button>
                <button id="stream-4-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-xl transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-lang-key="stream4Button">
                    Stream 4
                </button>
            </div>

            <!-- "You Might Also Like This" section for Layer 3 -->
            <div class="mt-8 text-center">
                <h3 class="text-xl font-bold text-gray-100 mb-4" data-lang-key="youMightAlsoLike">You Might Also Like This:</h3>
                <div id="static-movie-grid-layer3" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                    <!-- Static Movie Card: Intimacy (2001) - Corrected ID and type -->
                    <div class="static-movie-card" data-media-id="11845" data-media-type="movie">
                        <img src="https://image.tmdb.org/t/p/w300/I0mlv1FahaLJqu2ByffMXEn4NN.jpg" alt="Intimacy (2001) Poster" loading="lazy" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=IMAGE+ERROR';">
                        <div class="info">
                            <h3>Intimacy</h3>
                            <p>2001</p>
                        </div>
                    </div>
                    <!-- Static Movie Card: 3-D Sex and Zen: Extreme Ecstasy (2011) -->
                    <div class="static-movie-card" data-media-id="67308" data-media-type="movie">
                        <img src="https://image.tmdb.org/t/p/w300/jjADiLOmCoXoVldQYrNR9bdAWA0.jpg" alt="3-D Sex and Zen: Extreme Ecstasy (2011) Poster" loading="lazy" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=IMAGE+ERROR';">
                        <div class="info">
                            <h3>3-D Sex and Zen: Extreme Ecstasy</h3>
                            <p>2011</p>
                        </div>
                    </div>
                    <!-- Static Movie Card: Fidelity (2019) -->
                    <div class="static-movie-card" data-media-id="575299" data-media-type="movie">
                        <img src="https://image.tmdb.org/t/p/w300/kDaRVADrrbwNSGzCvU4AroEa6h1.jpg" alt="Fidelity (2019) Poster" loading="lazy" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=IMAGE+ERROR';">
                        <div class="info">
                            <h3>Fidelity</h3>
                            <p>2019</p>
                        </div>
                    </div>
                    <!-- Static Movie Card: Killing Me Softly (2002) -->
                    <div class="static-movie-card" data-media-id="14365" data-media-type="movie">
                        <img src="https://image.tmdb.org/t/p/w300/pgfFJw7mqAmJdZizrJ6oOK0ejOZ.jpg" alt="Killing Me Softly (2002) Poster" loading="lazy" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=IMAGE+ERROR';">
                        <div class="info">
                            <h3>Killing Me Softly</h3>
                            <p>2002</p>
                        </div>
                    </div>
                    <!-- Static Movie Card: They Are Mine (2023) -->
                    <div class="static-movie-card" data-media-id="1180449" data-media-type="movie">
                        <img src="https://image.tmdb.org/t/p/w300/66kzlgGMp9lKUiBjjPPYG0r8Z03.jpg" alt="They Are Mine (2023) Poster" loading="lazy" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=IMAGE+ERROR';">
                        <div class="info">
                            <h3>They Are Mine</h3>
                            <p>2023</p>
                        </div>
                    </div>
                    <!-- Static Movie Card: Hate Story 2 (2014) -->
                    <div class="static-movie-card" data-media-id="282346" data-media-type="movie">
                        <img src="https://image.tmdb.org/t/p/w300/y5fg6O5ttxvh2wkMY1fUchLfZSL.jpg" alt="Hate Story 2 (2014) Poster" loading="lazy" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=IMAGE+ERROR';">
                        <div class="info">
                            <h3>Hate Story 2</h3>
                            <p>2014</p>
                        </div>
                    </div>
                    <!-- Static Movie Card: Cashback (2006) -->
                    <div class="static-movie-card" data-media-id="12225" data-media-type="movie">
                        <img src="https://image.tmdb.org/t/p/w300/juTJZCgNwcEeKtrxC6EygC2mKfJ.jpg" alt="Cashback (2006) Poster" loading="lazy" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=IMAGE+ERROR';">
                        <div class="info">
                            <h3>Cashback</h3>
                            <p>2006</p>
                        </div>
                    </div>
                    <!-- Static Movie Card: Room in Rome (2010) -->
                    <div class="static-movie-card" data-media-id="48650" data-media-type="movie">
                        <img src="https://image.tmdb.org/t/p/w300/qQ8ithmufWYz0OzJbE2YuAn3Qaj.jpg" alt="Room in Rome (2010) Poster" loading="lazy" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=IMAGE+ERROR';">
                        <div class="info">
                            <h3>Room in Rome</h3>
                            <p>2010</p>
                        </div>
                    </div>
                    <!-- Static Movie Card: Fifty Shades Freed (2018) -->
                    <div class="static-movie-card" data-media-id="337167" data-media-type="movie">
                        <img src="https://image.tmdb.org/t/p/w300/9ZedQHPQVveaIYmDSTazhT3y273.jpg" alt="Fifty Shades Freed (2018) Poster" loading="lazy" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=IMAGE+ERROR';">
                        <div class="info">
                            <h3>Fifty Shades Freed</h3>
                            <p>2018</p>
                        </div>
                    </div>
                    <!-- Static Movie Card: Jan Dara (2001) -->
                    <div class="static-movie-card" data-media-id="68507" data-media-type="movie">
                        <img src="https://image.tmdb.org/t/p/w300/vE9h8C2FiOLXwli7NsTcn2MyWm6.jpg" alt="Jan Dara (2001) Poster" loading="lazy" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=IMAGE+ERROR';">
                        <div class="info">
                            <h3>Jan Dara</h3>
                            <p>2001</p>
                        </div>
                    </div>
                    <!-- New Static Movie Card: Hotel Desire (2011) - Re-added with new image and position -->
                    <div class="static-movie-card" data-media-id="82023" data-media-type="movie">
                        <img src="https://image.tmdb.org/t/p/w300/myzQj8Rk178DrWsiZjVKjz7Kj9P.jpg" alt="Hotel Desire (2011) Poster" loading="lazy" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=IMAGE+ERROR';">
                        <div class="info">
                            <h3>Hotel Desire</h3>
                            <p>2011</p>
                        </div>
                    </div>
                    <!-- New Static Movie Card: When Night is Falling (1995) -->
                    <div class="static-movie-card" data-media-id="8391" data-media-type="movie">
                        <img src="https://image.tmdb.org/t/p/w300/6Ac5GLwJ01uli5mCXqXwquR36Y1.jpg" alt="When Night is Falling (1995) Poster" loading="lazy" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=IMAGE+ERROR';">
                        <div class="info">
                            <h3>When Night is Falling</h3>
                            <p>1995</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Layer 4: Home Page -->
        <section id="layer-4" class="layer-4 bg-gray-800 p-6 md:p-8 rounded-lg shadow-xl text-center">
            <h2 class="text-4xl font-bold text-gray-100 mb-4" data-lang-key="homePageTitle">Putlocker US: Your Ultimate Gateway to Free Movies and TV Series Entertainment</h2>
            <p class="text-lg text-gray-300 mb-6" data-lang-key="homePageDescription">Your ultimate destination for free movies and TV series. Explore our vast library, stream in HD, and enjoy unlimited entertainment without any hassle.</p>
            <img src="https://live.staticflickr.com/65535/54680969764_a119fe1f10_b.jpg" alt="Putlocker US Homepage Banner" class="w-full max-w-xl mx-auto rounded-lg shadow-md mb-8">
            <p class="text-md text-gray-400 mb-8" data-lang-key="homePageCallToAction">Use the navigation above to browse movies, TV series, or search for your favorites!</p>
            
            <div class="text-left text-gray-300 space-y-6 text-justify">
                <h3 class="text-3xl font-bold text-gray-100 mt-10 mb-4">Why Putlocker US is Your Best Choice for Free Entertainment?</h3>
                <p>In this fast-paced digital era, access to high-quality entertainment often comes with a hefty price tag. Subscribing to various streaming platforms can quickly drain your wallet. However, Putlocker US emerges as a revolutionary solution, offering a vast library of movies and TV series for free, without the need for registration, and in stunning HD quality. We believe that entertainment should be accessible to everyone, and with this philosophy, Putlocker US was built to be your ultimate destination.</p>
                <p>From the very beginning, our mission at Putlocker US has been to democratize access to entertainment content. We understand the frustrations that come with geographical restrictions, ever-increasing subscription costs, and intrusive advertisements. Therefore, we have created a platform that not only eliminates these barriers but also enhances your overall viewing experience. With Putlocker US, you are not just watching a movie or a TV series; you are opening the door to limitless entertainment, where every click brings you closer to your favorite stories.</p>
                <p>Our commitment to free access is unwavering. We have invested heavily in robust infrastructure and efficient content delivery networks to ensure that our users can enjoy seamless streaming without any hidden costs. This dedication allows us to provide a premium viewing experience that rivals paid services, all while keeping it completely free. We continuously optimize our platform to reduce buffering and improve load times, so your entertainment is always just a click away, uninterrupted and crystal clear.</p>

                <h3 class="text-3xl font-bold text-gray-100 mt-10 mb-4">An Expansive Collection of Movies and TV Series: Always Something for Everyone</h3>
                <p>One of the main pillars that makes Putlocker US an unparalleled choice is our incredibly diverse and constantly updated content collection. We don't just offer the latest blockbuster movies that are currently the talk of the town, but also trending TV series, timeless classic films, and hidden gems from various genres. Whether you're a fan of thrilling action, heartwarming dramas, laugh-out-loud comedies, suspenseful horrors, or captivating science fiction, Putlocker US has it all.</p>
                <p>Our content curation team works tirelessly to ensure that our library is always fresh and relevant. We regularly add new titles as soon as they are released, so you'll never miss out on the latest film or episode of your favorite series. From Hollywood hits to independent cinema, from award-winning TV series to enlightening documentaries, Putlocker US is an ever-expanding repository of entertainment, designed to cater to every taste and preference. We understand that every viewer has unique preferences, and that's why we are committed to providing an endless selection, ensuring you always find something exciting to watch.</p>
                <p>Beyond quantity, we prioritize quality and variety. Our catalog is meticulously categorized, making it easy to discover new content based on your mood or specific interests. Explore curated lists, trending sections, and editor's picks to broaden your cinematic horizons. We also feature international films and series, giving you a global perspective on storytelling. This extensive and diverse collection ensures that Putlocker US remains your go-to source for all your entertainment needs, no matter how niche your preferences might be.</p>

                <h3 class="text-3xl font-bold text-gray-100 mt-10 mb-4">Stunning HD Quality: An Unmatched Viewing Experience</h3>
                <p>At Putlocker US, quality is a top priority. We understand that the best viewing experience can only be achieved with crisp visuals and immersive audio. Therefore, most of our content is available in full High Definition (HD) quality, ensuring every detail, color, and visual nuance is perfectly delivered to your screen. Forget blurry images or distracting pixelation; with Putlocker US, you will enjoy every scene as if you were in a cinema.</p>
                <p>Our streaming technology is optimized to provide smooth playback with minimal buffering, even with moderate internet connections. We utilize advanced infrastructure to ensure that you can enjoy movies or TV series without unnecessary interruptions. Whether you are watching on your smart TV's large screen, a laptop, tablet, or smartphone, Putlocker US guarantees a consistent and superior visual experience. We invest in the latest technology to ensure that our streaming quality is always at the forefront, giving you the cinematic experience you deserve, whenever and wherever you choose to watch.</p>
                <p>Furthermore, we continuously monitor and upgrade our servers to handle high traffic and deliver content efficiently. This proactive approach minimizes technical glitches and maximizes your enjoyment. We also support various resolutions, allowing you to choose the best quality for your device and internet speed. Our commitment to high-definition streaming means you can immerse yourself fully in the narratives, appreciating the intricate details and vibrant cinematography that filmmakers intended. Putlocker US is dedicated to providing a visual feast, making every viewing session a memorable one.</p>

                <h3 class="text-3xl font-bold text-gray-100 mt-10 mb-4">Unlimited Access: Free and Without Registration</h3>
                <p>One of the most attractive features of Putlocker US is its completely free and no-registration access model. We remove all barriers that often prevent you from enjoying entertainment. There are no hidden monthly subscription fees, no free trials that end with unexpected bills, and most importantly, no long and tedious registration forms asking for your personal information. Simply visit our site, choose the movie or TV series you want to watch, and start streaming.</p>
                <p>This freedom gives you full control over your entertainment experience. You are not bound by financial commitments or obligations to share personal data. It's a truly user-centric approach, designed to provide maximum convenience and privacy. We believe that trust is key, and by not asking for unnecessary information, we build a transparent relationship with our users. Enjoy unlimited viewing freedom, without worrying about hidden costs or privacy breaches, only at Putlocker US.</p>
                <p>Our commitment to a hassle-free experience extends to every aspect of our platform. We understand that your time is valuable, and we want you to spend it enjoying content, not navigating complex sign-up processes or dealing with payment issues. This simplicity is a core tenet of Putlocker US, making it accessible to a broader audience who might be hesitant to commit to paid subscriptions. We empower you to watch what you want, when you want, without any strings attached, fostering a sense of true freedom in your entertainment choices.</p>

                <h3 class="text-3xl font-bold text-gray-100 mt-10 mb-4">Intuitive and User-Friendly Interface: Easy Navigation</h3>
                <p>We understand that the best streaming platform is not just about great content, but also about how easy and enjoyable it is to use. That's why Putlocker US is designed with an incredibly intuitive and user-friendly interface. From the moment you land on our homepage, you will be greeted with a clean layout, clear navigation, and a powerful search feature that allows you to find what you're looking for in seconds.</p>
                <p>You can easily browse movies by genre, release date, popularity, or even search for specific titles with our responsive search bar. Every movie and TV series has its own detail page that provides comprehensive information such as synopsis, cast, director, rating, and trailer, helping you make informed decisions before watching. Our responsive design ensures that the site functions perfectly on all devices, from desktops to smartphones, providing a consistent and enjoyable experience wherever you are. We continuously listen to user feedback to refine our interface, making it more efficient and pleasant for every one of your visits.</p>
                <p>The thoughtful design of Putlocker US minimizes clutter and maximizes visual appeal, allowing the content to take center stage. Our categorization system is robust, enabling quick filtering by genre, year, or even specific keywords. The detail pages are rich with information, providing everything you need to know about a title at a glance, including cast profiles and related content suggestions. This streamlined navigation ensures that even first-time users can effortlessly explore our vast library and find their next favorite show or movie without any frustration.</p>

                <h3 class="text-3xl font-bold text-gray-100 mt-10 mb-4">Putlocker US's Premium Features: More Than Just Streaming</h3>
                <p>Putlocker US doesn't just stop at providing free streaming. We also offer a variety of additional features designed to enrich your entertainment experience. Our AI-powered "Why Watch This?" feature is one of our most exciting innovations. With a single click, you can get a brief and engaging insight into why a movie or TV series is worth watching, based on its plot. This helps you discover hidden gems or convince you to try something new.</p>
                <p>Additionally, we provide multiple streaming server options (Stream 1, Stream 2, Stream 3, Stream 4) to ensure playback availability and reliability. If one server experiences issues, you can easily switch to another. We also feature "You Might Also Like This" and "Top Rated Movies" recommendations on detail pages, helping you discover similar content that might pique your interest. These features are designed to make content browsing and discovery easier and more personal, ensuring you always have something exciting to enjoy.</p>
                <p>Our AI-driven recommendations are constantly learning from user interactions, providing increasingly accurate suggestions over time. This personalized discovery engine ensures that your entertainment journey on Putlocker US is always evolving and tailored to your tastes. The multi-server approach is a testament to our commitment to uninterrupted viewing, providing redundancy and resilience against potential technical issues. We strive to offer a holistic entertainment platform that goes beyond basic streaming, providing tools and features that enhance every aspect of your viewing experience.</p>

                <h3 class="text-3xl font-bold text-gray-100 mt-10 mb-4">Our Commitment to User Experience and Security</h3>
                <p>At Putlocker US, we are very serious about maintaining a smooth and secure user experience. We continuously monitor and update our infrastructure to ensure fast loading times, minimal buffering, and maximum content availability. User data security is a top priority, even though we do not require registration or sensitive personal information. We are committed to protecting your privacy and ensuring that your viewing experience is free from unwanted interruptions.</p>
                <p>We also value feedback from our user community. Your suggestions, criticisms, and bug reports are crucial for us to continuously improve and refine the Putlocker US platform. Our support team is always ready to listen and respond to your questions or concerns. With this user-centric approach, we strive to build a strong and loyal community, where everyone can enjoy high-quality entertainment with peace of mind and comfort.</p>
                <p>Our security protocols are robust, employing industry best practices to safeguard our platform against potential threats. While we don't collect personal data, we ensure that your browsing and streaming activities are protected. We are transparent about our practices and committed to maintaining a trustworthy environment. This dedication to security and user satisfaction is what sets Putlocker US apart, fostering a reliable and enjoyable space for all entertainment enthusiasts.</p>

                <h3 class="text-3xl font-bold text-gray-100 mt-10 mb-4">The Future of Putlocker US: Continuous Innovation and Growth</h3>
                <p>Our vision for Putlocker US extends far beyond what we offer today. We are constantly looking for innovative ways to expand our content library, enhance existing features, and introduce new technologies to enrich your viewing experience. We plan to add more genres, languages, and content formats in the future, ensuring Putlocker US remains at the forefront of the free streaming world.</p>
                <p>We are also exploring strategic partnerships and more advanced AI technology development to provide even more personalized recommendations and deeper insights. Our goal is to create a comprehensive entertainment ecosystem, where you can not only watch your favorite movies and TV series but also discover exciting new content, interact with a community, and enjoy an experience truly tailored to your preferences. Join us on this journey and witness how Putlocker US continues to evolve into the best free streaming platform in the world.</p>
                <p>The roadmap for Putlocker US includes integrating community features, allowing users to share reviews, create watchlists, and engage in discussions about their favorite titles. We envision a platform where entertainment is a shared experience, fostering connections among viewers worldwide. Furthermore, we are exploring advanced search capabilities, including voice search and image recognition, to make content discovery even more intuitive. Our commitment to innovation means Putlocker US will always be at the cutting edge of free online entertainment, continuously striving to exceed user expectations and redefine the streaming landscape.</p>

                <h3 classxl font-bold text-gray-100 mt-10 mb-4">Start Your Entertainment Journey Today with Putlocker US!</h3>
                <p>No need to wait any longer. If you are looking for a streaming platform that offers high-quality movies and TV series for free, without registration, and with an easy-to-use interface, Putlocker US is the answer. Explore our vast collection, find your next favorite movie, or catch up on trending TV series. With Putlocker US, unlimited entertainment is just a click away.</p>
                <p>We invite you to experience the difference Putlocker US offers. Forget the complexities of subscriptions and content limitations. Welcome a new era of free and easily accessible entertainment. Visit Putlocker US today and start your viewing adventure. We are confident you will discover why millions of users have chosen Putlocker US as their primary destination for online entertainment. Happy watching!</p>
                <p>Your ultimate cinematic adventure awaits. Dive into a world where every story is within reach, and every viewing experience is optimized for your enjoyment. Putlocker US is more than just a website; it's a community of entertainment lovers, a hub for discovery, and a testament to the idea that great content should be freely available to all. Join the Putlocker US family and unlock a universe of captivating narratives, thrilling adventures, and unforgettable characters. We are excited to have you on board!</p>
            </div>

            <div class="flex justify-center mt-8">
                <button id="back-from-home-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <span data-lang-key="moviesButton">Explore Movies</span>
                </button>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="w-full max-w-screen-xl mx-auto mt-12 py-8 bg-gray-900 text-gray-400 text-center text-sm border-t border-gray-700 rounded-t-lg">
        <div class="container mx-auto px-4">
            <p>&copy; <span id="current-year"></span> Putlocker US. <span data-lang-key="allRightsReserved">All rights reserved.</span></p>
            <p class="mt-2">
                <a href="#" class="hover:text-white transition-colors duration-200" data-lang-key="privacyPolicy">Privacy Policy</a> | 
                <a href="#" class="hover:text-white transition-colors duration-200" data-lang-key="termsOfService">Terms of Service</a> | 
                <a href="#" class="hover:text-white transition-colors duration-200" data-lang-key="contactUs">Contact Us</a>
            </p>
        </div>
    </footer>

    <script type="module">
        // **START OF MODIFICATION**

        // Removed Firebase initialization as it's not needed for current features
        // and __firebase_config is a Canvas-specific variable.
        // If you need Firebase (Auth, Firestore) on Cloudflare Pages,
        // you will need to manually add your Firebase project configuration here.

        let userId = crypto.randomUUID(); // Generate a random UUID for user identification
        console.log("User ID (generated locally):", userId);

        let isFetchingDetail = false; // Flag to prevent redundant detail fetches

        // **END OF MODIFICATION**

        // TMDB API Key
        const TMDB_API_KEY = '92d8deed10d8735da58f6777deee8a74';
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        const TMDB_IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w500'; 
        const TMDB_PROFILE_IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w185'; 

        let currentPage = 1;
        let currentSearchQuery = '';
        let currentGenreId = null;
        let currentMediaId = null; 
        let currentImdbId = null;
        let currentMediaType = 'movie'; // Default: 'movie'

        // Adsterra Direct Ad URLs (Diperbarui untuk menggunakan semua tautan)
        const ADSTERRA_DIRECT_LINKS = [
            'https://discreetisabella.com/x818nj48?key=db0a9d9fa9d81626b459383a7bdc33ee',
            'https://discreetisabella.com/gd8bwkyj?key=d2d35cf16f521bf5e9accfdd865dae8f',
            'https://discreetisabella.com/paij3re0by?key=fa60f72b73c05d987bd978f83a6deaa8',
            'https://discreetisabella.com/gh4tkda15?key=080742d09d4b5234a4fdaa773e48ebd4',
            'https://discreetisabella.com/u1ipxidjif?key=bf544685cc418fde38d3de4391de6fee',
            'https://discreetisabella.com/nu4ravi1cx?key=4d0556009c2d17968977e235d5de925a',
            'https://discreetisabella.com/wdhedf2wx?key=a2c98838af4390b59e8b7aaaea3f1660',
            'https://discreetisabella.com/yed8kj7bvw?key=b7830767455354f8e097df2a9e0f040c',
            'https://discreetisabella.com/w2sw8zgx21?key=d34ca1378210247721e98e65d20b3693',
            'https://discreetisabella.com/qn92sfcb?key=a8333f15c6bba15e367a5456f691547c',
            'https://discreetisabella.com/rz2xzbfm?key=8c4045c97068010d84c3f1002e82b1c9'
        ];

        // Fungsi untuk mendapatkan tautan iklan acak
        function getRandomAdLink() {
            const randomIndex = Math.floor(Math.random() * ADSTERRA_DIRECT_LINKS.length);
            return ADSTERRA_DIRECT_LINKS[randomIndex];
        }

        // Set to store media IDs for which an ad has already been triggered for the main grid
        const adTriggeredMediaIds = new Set();
        // New Set to store media IDs for which an ad has already been triggered for static cards
        const staticAdTriggeredMediaIds = new Set();

        // DOM Elements
        const movieGrid = document.getElementById('movie-grid');
        const loadMoreButton = document.getElementById('load-more-button');
        const layer1 = document.getElementById('layer-1');
        const layer2 = document.getElementById('layer-2');
        const layer3 = document.getElementById('layer-3');
        const layer4 = document.getElementById('layer-4'); // Added layer4
        const backToListButton = document.getElementById('back-to-list-button');
        const backToDetailButton = document.getElementById('back-to-detail-button');
        const backFromHomeButton = document.getElementById('back-from-home-button'); // Added backFromHomeButton
        const stream1Button = document.getElementById('stream-1-button');
        const stream2Button = document.getElementById('stream-2-button'); 
        const stream3Button = document.getElementById('stream-3-button');
        const stream4Button = document.getElementById('stream-4-button');
        // Renamed staticMovieGrid to topRatedMovieGridLayer2
        const topRatedMovieGridLayer2 = document.getElementById('top-rated-movie-grid-layer2'); 
        // New static movie grid for Layer 3 (retains original name)
        const staticMovieGridLayer3 = document.getElementById('static-movie-grid-layer3'); // Corrected ID

        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const noResultsMessage = document.getElementById('no-results-message');
        const genreButtonsContainer = document.querySelector('.genre-buttons-container');
        const sectionTitle = document.getElementById('section-title');

        const loadingSpinnerLayer1 = document.getElementById('loading-spinner-layer1');
        const loadingSpinnerLayer2 = document.getElementById('loading-spinner-layer2');
        const loadingSpinnerLayer3 = document.getElementById('loading-spinner-layer3');

        const whyWatchButton = document.getElementById('why-watch-button');
        const whyWatchOutput = document.getElementById('why-watch-output');
        const whyWatchText = document.getElementById('why-watch-text');
        const whyWatchSpinner = document.getElementById('why-watch-spinner');

        const navHomeButton = document.getElementById('nav-home-button'); // Added navHomeButton
        const navMoviesButton = document.getElementById('nav-movies-button');
        const navTvSeriesButton = document.getElementById('nav-tvseries-button');
        // const languageSelector = document.getElementById('language-selector'); // Removed language selector

        // New detail elements
        const detailYear = document.getElementById('detail-year');
        const detailAka = document.getElementById('detail-aka');
        const detailAgeRating = document.getElementById('detail-age-rating');
        const detailDirector = document.getElementById('detail-director');

        // Maps genre names to TMDB IDs - Only 10 requested genres (for Movies)
        const fixedMovieGenres = {
            "Action": 28,
            "Adventure": 12,
            "Comedy": 35,
            "Crime": 80,
            "Drama": 18,
            "Fantasy": 14,
            "Horror": 27,
            "Mystery": 9648,
            "Sci-Fi": 878,
            "Thriller": 53
        };

        // Translations object - Updated appTitle and related descriptions for "Putlocker US"
        const translations = {
            es: {
                appTitle: "Putlocker US",
                metaDescription: "Putlocker US: Transmita y descargue las √∫ltimas pel√≠culas y series de TV en HD de forma gratuita. ¬°Disfrute de entretenimiento ilimitado sin registrarse. ¬°Mire ahora en Putlocker US!",
                metaKeywords: "Putlocker US, pel√≠culas gratis en l√≠nea, transmisi√≥n HD, ver series de TV, √∫ltimas pel√≠culas, descargar pel√≠culas, sin registro, entretenimiento gratis, sitio de pel√≠culas en l√≠nea, pel√≠culas, series de TV, streaming, HD completo",
                ogDescription: "Putlocker US: Transmita y descargue las √∫ltimas pel√≠culas y series de TV en HD de forma gratuita. ¬°Disfrute de entretenimiento ilimitado sin registrarse. ¬°Mire ahora en Putlocker US!",
                homeButton: "Inicio", // New translation
                moviesButton: "Pel√≠culas",
                tvSeriesButton: "Series de TV",
                searchMoviesPlaceholder: "Buscar pel√≠culas...",
                searchTvSeriesPlaceholder: "Buscar series de TV...",
                popularMovies: "Pel√≠culas y Series de TV Populares", // Updated for general content
                popularTvSeries: "Series de TV Populares",
                loadMoreButton: "Cargar M√°s",
                noResultsFound: "No se encontraron resultados para su b√∫squeda.",
                posterNotAvailable: "P√ìSTER NO DISPONIBLE",
                imageError: "ERROR IMAGEN",
                titleNotAvailable: "T√≠tulo no disponible",
                yearNotAvailable: "A√±o no disponible",
                noPoster: "Sin P√≥ster",
                castPrefix: "Elenco: ",
                plotNotAvailable: "Trama no disponible.",
                whyWatchButtonText: "¬øPor qu√© ver esto?", 
                insightTitle: "Informaci√≥n de Putlocker US:", // Updated for new name
                stream1Button: "Stream 1",
                stream2Button: "Stream 2",
                stream3Button: "Stream 3",
                stream4Button: "Stream 4",
                youMightAlsoLike: "Tambi√©n te podr√≠a gustar esto:",
                topRatedMovies: "Pel√≠culas Mejor Calificadas:", 
                handpickedMovies: "Algunas Pel√≠culas Seleccionadas:", 
                allRightsReserved: "Todos los derechos reservados.",
                privacyPolicy: "Pol√≠tica de Privacidad",
                termsOfService: "T√©rminos de Servicio",
                contactUs: "Cont√°ctenos",
                errorTitle: "Error",
                infoTitle: "Informaci√≥n",
                failedToLoadMedia: "No se pudieron cargar los medios. Por favor, int√©ntelo de nuevo m√°s tarde.",
                failedToLoadDetails: "No se pudieron cargar los detalles de los medios. Por favor, int√©ntelo de nuevo.",
                noMediaSelected: "No se seleccion√≥ ning√∫n medio para streaming.",
                imdbIdNotAvailable: "ID de IMDb no disponible para streaming. Por favor, pruebe Stream 1.",
                noPlotForInsight: "El resumen de la trama para esta {mediaTypeName} no est√° disponible para generar informaci√≥n.",
                llmNoInsight: "No se pudo generar informaci√≥n en este momento. Por favor, int√©ntelo de nuevo m√°s tarde.",
                llmApiError: "Ocurri√≥ un error al contactar con el servicio de IA. Por favor, int√©ntelo de nuevo.",
                invalidMediaHash: "Hash de medio no v√°lido, cargando pel√≠culas populares.",
                notAvailable: "N/A",
                productionYearPrefix: "A√±o Producci√≥n: ", 
                akaPrefix: "Tambi√©n Conocido Como: ", 
                ageRatingPrefix: "Clasificaci√≥n por Edad: ", 
                directorPrefix: "Director: ", 
                homePageTitle: "Putlocker US: Su Puerta de Entrada Definitiva al Entretenimiento Gratuito de Pel√≠culas y Series de TV", // Updated for new name
                homePageDescription: "Su destino definitivo para pel√≠culas y series de TV gratuitas. Explore nuestra amplia biblioteca, transmita en HD, y disfrute de entretenimiento ilimitado sin complicaciones.",
                homePageCallToAction: "¬°Use la navegaci√≥n de arriba para explorar pel√≠culas, series de TV, o buscar sus favoritos!",
                genres: {
                    "Action": "Acci√≥n",
                    "Adventure": "Aventura",
                    "Comedy": "Comedia",
                    "Crime": "Crimen",
                    "Drama": "Drama",
                    "Fantasy": "Fantasia",
                    "Horror": "Terror",
                    "Mystery": "Misterio",
                    "Sci-Fi": "Ciencia Ficci√≥n",
                    "Thriller": "Suspense",
                    "All": "Todos"
                }
            },
            en: {
                appTitle: "Putlocker US", // Renamed app title
                metaDescription: "Putlocker US: Stream and download the latest movies & TV series in Full HD for free! Enjoy unlimited entertainment without registration. Watch blockbuster films, trending shows, and classic cinema online now!", // Updated description
                metaKeywords: "free movies online, watch movies free, HD streaming, watch TV series, latest movies, download movies, no sign-up, free entertainment, online movie site, Putlocker US, stream films, full HD, movie streaming, TV show streaming", // Updated keywords
                ogDescription: "Putlocker US: Stream and download the latest movies & TV series in Full HD for free! Enjoy unlimited entertainment without registration. Watch blockbuster films, trending shows, and classic cinema online now!", // Updated OG description
                homeButton: "Home", 
                moviesButton: "Movies",
                tvSeriesButton: "TV Series",
                searchMoviesPlaceholder: "Search movies...",
                searchTvSeriesPlaceholder: "Search TV series...",
                popularMovies: "Popular Movies & TV Shows Streaming Now", // Updated for general content
                popularTvSeries: "Popular TV Series",
                loadMoreButton: "Load More",
                noResultsFound: "No results found for your search.",
                posterNotAvailable: "POSTER NOT AVAILABLE",
                imageError: "IMAGE ERROR",
                titleNotAvailable: "Title Not Available",
                yearNotAvailable: "Year Not Available",
                noPoster: "No Poster",
                castPrefix: "Cast: ",
                plotNotAvailable: "No plot available.",
                whyWatchButtonText: "Why Watch This?", 
                insightTitle: "Insight from Putlocker US:", // Updated for new name
                stream1Button: "Stream 1",
                stream2Button: "Stream 2",
                stream3Button: "Stream 3",
                stream4Button: "Stream 4",
                youMightAlsoLike: "You Might Also Like This:",
                topRatedMovies: "Top Rated Movies:", 
                handpickedMovies: "Some Handpicked Movies:", 
                allRightsReserved: "All rights reserved.",
                privacyPolicy: "Privacy Policy",
                termsOfService: "Terms of Service",
                contactUs: "Contact Us",
                errorTitle: "Error",
                infoTitle: "Info",
                failedToLoadMedia: "Failed to load media. Please try again later.",
                failedToLoadDetails: "Failed to try again.",
                noMediaSelected: "No media selected for streaming.",
                imdbIdNotAvailable: "IMDb ID not available for streaming. Please try Stream 1.",
                noPlotForInsight: "Plot summary for this {mediaTypeName} is not available to generate insights.",
                llmNoInsight: "Could not generate insight at this time. Please try again later.",
                llmApiError: "An error occurred while contacting the AI service. Please try again.",
                invalidMediaHash: "Invalid media hash, loading popular movies.",
                notAvailable: "N/A",
                productionYearPrefix: "Production Year: ", 
                akaPrefix: "Also Known As: ", 
                ageRatingPrefix: "Age Rating: ", 
                directorPrefix: "Director: ", 
                homePageTitle: "Putlocker US: Your Ultimate Gateway to Free Movies and TV Series Entertainment", // Updated for new name
                homePageDescription: "Your ultimate destination for free movies and TV series. Explore our vast library, stream in HD, and enjoy unlimited entertainment without any hassle.",
                homePageCallToAction: "Use the navigation above to browse movies, TV series, or search for your favorites!",
                genres: {
                    "Action": "Action",
                    "Adventure": "Adventure",
                    "Comedy": "Comedy",
                    "Crime": "Crime",
                    "Drama": "Drama",
                    "Fantasy": "Fantasy",
                    "Horror": "Horror",
                    "Mystery": "Mystery",
                    "Sci-Fi": "Sci-Fi",
                    "Thriller": "Thriller",
                    "All": "All"
                }
            },
            id: {
                appTitle: "Putlocker US", // Renamed app title
                metaDescription: "Putlocker US: Streaming dan unduh film & serial TV terbaru dalam HD gratis! Nikmati hiburan tanpa batas tanpa perlu mendaftar. Tonton film blockbuster, acara TV trending, dan sinema klasik online sekarang!", // Updated description
                metaKeywords: "film gratis online, nonton film gratis, streaming HD, nonton serial TV, film terbaru, unduh film, tanpa daftar, hiburan gratis, situs film online, Putlocker US, streaming film, full HD, streaming film, streaming acara TV", // Updated keywords
                ogDescription: "Putlocker US: Streaming dan unduh film & serial TV terbaru dalam HD gratis! Nikmati hiburan tanpa batas tanpa perlu mendaftar. Tonton film blockbuster, acara TV trending, dan sinema klasik online sekarang!", // Updated OG description
                homeButton: "Beranda", 
                moviesButton: "Film",
                tvSeriesButton: "Serial TV",
                searchMoviesPlaceholder: "Cari film...",
                searchTvSeriesPlaceholder: "Cari serial TV...",
                popularMovies: "Film & Serial TV Populer Streaming Sekarang", // Updated for general content
                popularTvSeries: "Serial TV Populer",
                loadMoreButton: "Muat Lebih Banyak",
                noResultsFound: "Tidak ada hasil ditemukan untuk pencarian Anda.",
                posterNotAvailable: "POSTER TIDAK TERSEDIA",
                imageError: "KESALAHAN GAMBAR",
                titleNotAvailable: "Judul Tidak Tersedia",
                yearNotAvailable: "Tahun Tidak Tersedia",
                noPoster: "Tidak Ada Poster",
                castPrefix: "Pemeran: ",
                plotNotAvailable: "Plot tidak tersedia.",
                whyWatchButtonText: "Mengapa Menonton Ini?", 
                insightTitle: "Wawasan dari Putlocker US:", // Updated for new name
                stream1Button: "Stream 1",
                stream2Button: "Stream 2",
                stream3Button: "Stream 3",
                stream4Button: "Stream 4",
                youMightAlsoLike: "Anda Mungkin Juga Menyukai Ini:",
                topRatedMovies: "Film Peringkat Teratas:", 
                handpickedMovies: "Beberapa Film Pilihan:", 
                allRightsReserved: "Semua hak dilindungi undang-undang.",
                privacyPolicy: "Kebijakan Privasi",
                termsOfService: "Ketentuan Layanan",
                contactUs: "Hubungi Kami",
                errorTitle: "Kesalahan",
                infoTitle: "Info",
                failedToLoadMedia: "Gagal memuat media. Silakan coba lagi nanti.",
                failedToLoadDetails: "Gagal memuat detail media. Silakan coba lagi.",
                noMediaSelected: "Tidak ada media yang dipilih untuk streaming.",
                imdbIdNotAvailable: "ID IMDb tidak tersedia untuk streaming. Silakan coba Stream 1.",
                noPlotForInsight: "Ringkasan plot untuk {mediaTypeName} ini tidak tersedia untuk menghasilkan wawasan.",
                llmNoInsight: "Tidak dapat menghasilkan wawasan saat ini. Silakan coba lagi nanti.",
                llmApiError: "Terjadi kesalahan saat menghubungi layanan AI. Silakan coba lagi.",
                invalidMediaHash: "Hash media tidak valid, memuat film populer.",
                notAvailable: "N/A",
                productionYearPrefix: "Tahun Produksi: ", 
                akaPrefix: "Juga Dikenal Sebagai: ", 
                ageRatingPrefix: "Usia Penonton: ", 
                directorPrefix: "Direktur: ", 
                homePageTitle: "Putlocker US: Tujuan Utama Anda untuk Hiburan Film dan Serial TV Gratis", // Updated for new name
                homePageDescription: "Tujuan utama Anda untuk film dan serial TV gratis. Jelajahi perpustakaan kami yang luas, streaming dalam HD, dan nikmati hiburan tanpa batas tanpa kerumitan.",
                homePageCallToAction: "Gunakan navigasi di atas untuk menjelajahi film, serial TV, atau mencari favorit Anda!",
                genres: {
                    "Action": "Aksi",
                    "Adventure": "Petualangan",
                    "Comedy": "Komedi",
                    "Crime": "Kriminal",
                    "Drama": "Drama",
                    "Fantasy": "Fantasi",
                    "Horror": "Horor",
                    "Mystery": "Misteri",
                    "Sci-Fi": "Fiksi Ilmiah",
                    "Thriller": "Thriller",
                    "All": "Semua"
                }
            }
        };

        // Dynamic TMDB endpoints based on media type
        const mediaTypeEndpoints = {
            movie: {
                popular: '/movie/popular',
                search: '/search/movie',
                detail: '/movie/',
                videos: '/movie/',
                credits: '/movie/',
                alternativeTitles: '/movie/',
                releaseDates: '/movie/',
                topRated: '/movie/top_rated', // Added top_rated endpoint
            },
            tv: {
                popular: '/tv/popular',
                search: '/search/tv',
                detail: '/tv/',
                videos: '/tv/',
                credits: '/tv/',
                alternativeTitles: '/tv/',
                contentRatings: '/tv/',
            }
        };

        /**
         * Converts text to a URL-friendly slug format.
         * Example: "The Dark Knight" -> "the-dark-knight"
         * @param {string} text - The text to slugify.
         * @returns {string} - The text in slug format.
         */
        function slugify(text) {
            return text
                .toString()
                .normalize('NFD') // Normalizes diacritics
                .replace(/[\u0300-\u036f]/g, '') // Removes diacritics
                .toLowerCase() // Converts to lowercase
                .trim() // Trims leading/trailing whitespace
                .replace(/\s+/g, '-') // Replaces spaces with hyphens
                .replace(/[^\w-]+/g, '') // Removes all non-alphanumeric characters
                .replace(/--+/g, '-'); // Replaces multiple hyphens with a single hyphen
        }

        // Function to show/hide layers
        function showLayer(layerToShow) {
            if (layer1) layer1.style.display = 'none';
            if (layer2) layer2.style.display = 'none';
            if (layer3) layer3.style.display = 'none';
            if (layer4) layer4.style.display = 'none'; // Hide layer4
            if (layerToShow) layerToShow.style.display = 'block';
            window.scrollTo(0, 0); // Scroll to top when changing layers
        }

        /**
         * Displays a custom message box with translatable content.
         * @param {string} titleKey - The key for the title in the translations object.
         * @param {string} messageKey - The key for the message in the translations object.
         * @param {Object} [replacements={}] - Optional object for string replacements in the message.
         */
        function showMessageBox(titleKey, messageKey, replacements = {}) {
            const currentLangCode = 'en'; // Hardcoded to English
            const currentLang = translations[currentLangCode];

            let title = currentLang[titleKey] || titleKey;
            let message = currentLang[messageKey] || messageKey;

            for (const key in replacements) {
                message = message.replace(`{${key}}`, replacements[key]);
            }

            const existingMessageBox = document.getElementById('custom-message-box');
            if (existingMessageBox) {
                existingMessageBox.remove();
            }

            const messageBox = document.createElement('div');
            messageBox.id = 'custom-message-box';
            messageBox.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1000] p-4';
            messageBox.innerHTML = `
                <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-sm w-full text-center border-t-4 border-indigo-500">
                    <h3 class="text-2xl font-bold text-gray-100 mb-4">${title}</h3>
                    <p class="text-gray-300 mb-6">${message}</p>
                    <button id="message-box-ok" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        OK
                    </button>
                </div>
            `;
            document.body.appendChild(messageBox);

            document.getElementById('message-box-ok').addEventListener('click', () => {
                messageBox.remove();
            });
        }

        /**
         * Sets the language of the application.
         * @param {string} langCode - The language code (e.e., 'es', 'en', 'id').
         */
        function setLanguage(langCode) {
            document.documentElement.lang = langCode; // Set HTML lang attribute
            localStorage.setItem('siyatniLang', langCode); // Store preference
            // languageSelector.value = langCode; // Update selector to reflect current language - REMOVED

            const currentLang = translations[langCode];

            // Update elements with data-lang-key attributes
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.dataset.langKey;
                if (currentLang[key]) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.placeholder = currentLang[key];
                    } else {
                        element.textContent = currentLang[key];
                    }
                }
            });

            // Update elements with data-lang-prefix attributes
            document.querySelectorAll('[data-lang-prefix]').forEach(element => {
                const prefixKey = element.dataset.langPrefix;
                // Remove existing prefixes from all languages before applying the new one
                let originalText = element.textContent;
                for (const lang in translations) {
                    originalText = originalText.replace(translations[lang][prefixKey], '').trim();
                }
                element.textContent = currentLang[prefixKey] + originalText;
            });

            // Update specific dynamic elements
            if (sectionTitle) { // Added null check
                sectionTitle.textContent = currentLang[currentMediaType === 'movie' ? 'popularMovies' : 'popularTvSeries'];
            }
            if (searchInput) { // Added null check
                searchInput.placeholder = currentLang[currentMediaType === 'movie' ? 'searchMoviesPlaceholder' : 'searchTvSeriesPlaceholder'];
            }
            
            // Re-initialize genre buttons to update their text
            initializeGenreButtons();
        }


        // Function to fetch and display movies/TV series (Layer 1)
        async function fetchAndDisplayMedia(type, page = 1, query = '', genreId = null) {
            currentMediaType = type; // Update current media type
            if (loadingSpinnerLayer1) loadingSpinnerLayer1.classList.remove('hidden'); // Added null check
            if (noResultsMessage) noResultsMessage.classList.add('hidden'); // Added null check
            let url = '';

            const currentLangCode = 'en'; // Hardcoded to English
            const currentLang = translations[currentLangCode]; // Default to English

            // Update section title
            if (sectionTitle) { // Added null check
                sectionTitle.textContent = currentLang[type === 'movie' ? 'popularMovies' : 'popularTvSeries'];
            }
            if (searchInput) { // Added null check
                searchInput.placeholder = currentLang[type === 'movie' ? 'searchMoviesPlaceholder' : 'searchTvSeriesPlaceholder'];
            }
            
            // Determine URL based on media type, query, or genre
            if (query) {
                url = `${TMDB_BASE_URL}${mediaTypeEndpoints[type].search}?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}&page=${page}&language=${currentLangCode}`;
            } else if (genreId && type === 'movie') { // Filter genre only for movies, as requested
                url = `${TMDB_BASE_URL}/discover/movie?api_key=${TMDB_API_KEY}&with_genres=${genreId}&page=${page}&language=${currentLangCode}`;
            } else {
                url = `${TMDB_BASE_URL}${mediaTypeEndpoints[type].popular}?api_key=${TMDB_API_KEY}&page=${page}&language=${currentLangCode}`;
            }

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (page === 1) { // Clear existing media if it's a new search or initial load
                    if (movieGrid) movieGrid.innerHTML = ''; // Added null check
                }

                if (data.results.length === 0 && page === 1) {
                    if (noResultsMessage) { // Added null check
                        noResultsMessage.classList.remove('hidden'); 
                        noResultsMessage.textContent = currentLang.noResultsFound;
                    }
                    if (loadMoreButton) loadMoreButton.classList.add('hidden'); // Added null check
                } else if (data.results.length > 0) {
                    if (noResultsMessage) noResultsMessage.classList.add('hidden'); // Added null check
                    if (loadMoreButton) loadMoreButton.classList.remove('hidden'); // Added null check
                    data.results.forEach(media => {
                        console.log('Processing media:', media); // Debug log for each media object
                        const mediaCard = document.createElement('div');
                        mediaCard.className = 'bg-gray-800 rounded-lg shadow-md overflow-hidden transform transition-all duration-300 hover:scale-105 hover:shadow-xl cursor-pointer';
                        mediaCard.dataset.mediaId = media.id;
                        mediaCard.dataset.mediaType = type; // Store media type in dataset

                        const posterPath = media.poster_path ? `${TMDB_IMAGE_BASE_URL}${media.poster_path}` : `https://placehold.co/500x750/FF0000/FFFFFF?text=${currentLang.posterNotAvailable}`; // More aggressive placeholder
                        console.log('Generated poster path:', posterPath); // Log generated path
                        const titleOrName = media.title || media.name || currentLang.titleNotAvailable;
                        const releaseDateOrFirstAirDate = media.release_date ? media.release_date.substring(0, 4) : (media.first_air_date ? media.first_air_date.substring(0, 4) : currentLang.yearNotAvailable);

                        mediaCard.innerHTML = `
                            <img src="${posterPath}" alt="${titleOrName} Poster" loading="lazy" class="w-full h-auto object-cover rounded-t-lg" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=${currentLang.imageError}';">
                            <div class="p-4 text-center"> <!-- Added text-center here -->
                                <h3 class="text-lg font-semibold text-gray-100 truncate">${titleOrName}</h3>
                                <p class="text-gray-400 text-sm">${releaseDateOrFirstAirDate}</p>
                            </div>
                        `;
                        if (movieGrid) movieGrid.appendChild(mediaCard); // Added null check
                        console.log('mediaCard added to movieGrid'); // Confirm addition

                        mediaCard.addEventListener('click', () => {
                            console.log('Media card clicked:', media.id, type, titleOrName); // Debug log
                            currentMediaId = media.id;
                            
                            // Adsterra Direct Ad Logic: Open ad on first click for this mediaId
                            if (!adTriggeredMediaIds.has(media.id)) {
                                window.open(getRandomAdLink(), '_blank'); // Menggunakan tautan acak
                                adTriggeredMediaIds.add(media.id); // Mark as triggered
                            }
                            
                            fetchAndDisplayMediaDetail(media.id, type, titleOrName); // Proceed to Layer 2
                        });
                    });
                }

                if (data.page >= data.total_pages) {
                    if (loadMoreButton) loadMoreButton.classList.add('hidden'); // Added null check
                } else {
                    if (loadMoreButton) loadMoreButton.classList.remove('hidden'); // Added null check
                }

                currentPage = data.page; // Update current page based on API response
            } catch (error) {
                console.error('Error fetching media:', error);
                showMessageBox('errorTitle', 'failedToLoadMedia');
                if (loadMoreButton) loadMoreButton.classList.add('hidden'); // Added null check
                if (noResultsMessage) { // Added null check
                    noResultsMessage.classList.remove('hidden');
                    noResultsMessage.textContent = currentLang.failedToLoadMedia;
                }
            } finally {
                if (loadingSpinnerLayer1) loadingSpinnerLayer1.classList.add('hidden'); // Added null check
            }
        }

        /**
         * Fetches and displays top-rated movies in the specified container.
         * @param {string} containerElementId - The ID of the HTML element to populate.
         */
        async function fetchAndDisplayTopRatedMovies(containerElementId) {
            const container = document.getElementById(containerElementId);
            if (!container) {
                console.error(`Container with ID "${containerElementId}" not found.`);
                return;
            }
            console.log(`Clearing container: ${containerElementId} before fetching top rated movies. Current children: ${container.children.length}`);
            // Clear existing content using a loop for robustness
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            console.log(`Container ${containerElementId} cleared. Children after clear: ${container.children.length}`);

            const currentLangCode = 'en'; // Hardcoded to English
            const currentLang = translations[currentLangCode];

            try {
                const url = `${TMDB_BASE_URL}${mediaTypeEndpoints.movie.topRated}?api_key=${TMDB_API_KEY}&language=${currentLangCode}&page=1`;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // Take top 12 movies
                const topMovies = data.results.slice(0, 12);
                console.log(`Fetched ${data.results.length} top rated movies from API, displaying ${topMovies.length}.`);

                topMovies.forEach(media => {
                    const mediaCard = document.createElement('div');
                    mediaCard.className = 'static-movie-card'; // Re-use static-movie-card class for styling
                    mediaCard.dataset.mediaId = media.id;
                    mediaCard.dataset.mediaType = 'movie'; // Always 'movie' for top rated
                    
                    const posterPath = media.poster_path ? `${TMDB_IMAGE_BASE_URL}${media.poster_path}` : `https://placehold.co/300x450/FF0000/FFFFFF?text=${currentLang.posterNotAvailable}`;
                    const title = media.title || currentLang.titleNotAvailable;
                    const year = media.release_date ? media.release_date.substring(0, 4) : currentLang.yearNotAvailable;

                    mediaCard.innerHTML = `
                        <img src="${posterPath}" alt="${title} Poster" loading="lazy" class="w-full h-auto object-cover rounded-t-lg" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=${currentLang.imageError}';">
                        <div class="info">
                            <h3>${title}</h3>
                            <p>${year}</p>
                        </div>
                    `;
                    container.appendChild(mediaCard);
                });
                console.log(`Finished appending top rated movies to ${containerElementId}. Total children after append: ${container.children.length}`);
            } catch (error) {
                console.error('Error fetching top rated movies:', error);
                // Optionally display a message if top rated movies can't be loaded
                const errorMessage = document.createElement('p');
                errorMessage.className = 'text-center text-gray-400 text-lg mt-4';
                errorMessage.textContent = currentLang.failedToLoadMedia;
                container.appendChild(errorMessage);
            }
        }


        // Function to fetch and display movie/TV details (Layer 2)
        async function fetchAndDisplayMediaDetail(mediaId, mediaType, mediaTitleForSlug = '') {
            console.log('--- fetchAndDisplayMediaDetail called ---');
            console.trace(); // Log the call stack to see where it's called from

            if (isFetchingDetail) {
                console.log('Already fetching details, ignoring redundant call.');
                return;
            }
            isFetchingDetail = true; // Set flag to true at the beginning

            console.log('Fetching details for:', mediaId, mediaType); // Debug log
            showLayer(layer2);
            if (document.getElementById('movie-detail-content')) document.getElementById('movie-detail-content').classList.add('hidden'); // Added null check
            if (loadingSpinnerLayer2) loadingSpinnerLayer2.classList.remove('hidden'); // Added null check
            // Reset LLM output and hide it when loading new media details
            if (whyWatchOutput) whyWatchOutput.classList.add('hidden'); // Added null check
            if (whyWatchText) whyWatchText.textContent = ''; // Added null check
            if (whyWatchSpinner) whyWatchSpinner.classList.add('hidden'); // Added null check

            const currentLangCode = 'en'; // Hardcoded to English
            const currentLang = translations[currentLangCode]; // Default to English

            try {
                // Fetch media details
                const detailResponse = await fetch(`${TMDB_BASE_URL}${mediaTypeEndpoints[mediaType].detail}${mediaId}?api_key=${TMDB_API_KEY}&language=${currentLangCode}`);
                if (!detailResponse.ok) throw new Error(`HTTP error! status: ${detailResponse.status}`);
                const media = await detailResponse.json();

                // Update URL hash for uniqueness and SEO
                // Use the media's actual title/name from the API response for the slug
                const actualMediaTitle = media.title || media.name || currentLang.titleNotAvailable;
                const mediaSlug = slugify(actualMediaTitle);
                window.location.hash = `#/media/${mediaType}/${media.id}/${mediaSlug}`;

                // Fetch media videos (for trailer)
                const videoResponse = await fetch(`${TMDB_BASE_URL}${mediaTypeEndpoints[mediaType].videos}${mediaId}/videos?api_key=${TMDB_API_KEY}&language=${currentLangCode}`);
                if (!videoResponse.ok) throw new Error(`HTTP error! status: ${videoResponse.status}`);
                const videosData = await videoResponse.json();
                console.log('TMDB videos data:', videosData); // Log all video data

                let trailer = videosData.results.find(vid => vid.type === 'Trailer' && vid.site === 'YouTube');
                
                // Fallback: if no specific 'Trailer' type is found, try any YouTube video
                if (!trailer) {
                    trailer = videosData.results.find(vid => vid.site === 'YouTube');
                    console.log('No "Trailer" found, falling back to any YouTube video:', trailer);
                }

                // MODIFIED: Using Big Buck Bunny trailer as the new fallback
                const trailerUrl = trailer ? `https://www.youtube.com/embed/${trailer.key}` : 'https://www.youtube.com/embed/YE7VzlLtp-4';
                console.log('Final trailer URL:', trailerUrl); // Log final trailer URL

                // Fetch media credits (for cast and director)
                const creditsResponse = await fetch(`${TMDB_BASE_URL}${mediaTypeEndpoints[mediaType].credits}${mediaId}/credits?api_key=${TMDB_API_KEY}&language=${currentLangCode}`);
                if (!creditsResponse.ok) throw new Error(`HTTP error! status: ${creditsResponse.status}`);
                const creditsData = await creditsResponse.json();
                // MODIFIED: Safely access cast and use currentLang.notAvailable if undefined
                const cast = creditsData.cast?.slice(0, 5).map(person => person.name).join(', ') || currentLang.notAvailable;
                const director = creditsData.crew.find(person => person.job === 'Director')?.name || currentLang.notAvailable;

                // Fetch alternative titles
                const alternativeTitlesResponse = await fetch(`${TMDB_BASE_URL}${mediaTypeEndpoints[mediaType].alternativeTitles}${mediaId}/alternative_titles?api_key=${TMDB_API_KEY}`);
                if (!alternativeTitlesResponse.ok) console.warn(`Failed to fetch alternative titles for ${mediaType} ${mediaId}`);
                const alternativeTitlesData = alternativeTitlesResponse.ok ? await alternativeTitlesResponse.json() : { titles: [] };
                // MODIFIED: Safely access titles and use currentLang.notAvailable if undefined
                const alternativeTitles = alternativeTitlesData.titles?.slice(0, 3).map(t => t.title).join(', ') || currentLang.notAvailable;

                // Fetch release dates/content ratings for age certification
                let ageRating = currentLang.notAvailable;
                // Declare releaseDatesData and contentRatingsData outside the if blocks
                let releaseDatesData = { results: [] }; 
                let contentRatingsData = { results: [] };

                if (mediaType === 'movie') {
                    const releaseDatesResponse = await fetch(`${TMDB_BASE_URL}${mediaTypeEndpoints[mediaType].releaseDates}${mediaId}/release_dates?api_key=${TMDB_API_KEY}`);
                    if (releaseDatesResponse.ok) {
                        releaseDatesData = await releaseDatesResponse.json(); // Assign value here
                        const usRelease = releaseDatesData.results.find(r => r.iso_3166_1 === 'US');
                        if (usRelease && usRelease.release_dates.length > 0) {
                            ageRating = usRelease.release_dates[0].certification || currentLang.notAvailable;
                        }
                    } else {
                        console.warn(`Failed to fetch release dates for movie ${mediaId}`);
                    }
                } else if (mediaType === 'tv') {
                    const contentRatingsResponse = await fetch(`${TMDB_BASE_URL}${mediaTypeEndpoints[mediaType].contentRatings}${mediaId}/content_ratings?api_key=${TMDB_API_KEY}`);
                    if (contentRatingsResponse.ok) {
                        contentRatingsData = await contentRatingsResponse.json(); // Assign value here
                        const usRating = contentRatingsData.results.find(r => r.iso_3166_1 === 'US');
                        if (usRating) {
                            ageRating = usRating.rating || currentLang.notAvailable;
                        }
                    } else {
                        console.warn(`Failed to fetch content ratings for TV series ${mediaId}`);
                    }
                }

                // Update currentImdbId
                currentImdbId = media.imdb_id; // IMDb ID is available for both movies and TV in TMDB details

                // Populate Layer 2
                if (document.getElementById('detail-poster')) document.getElementById('detail-poster').src = media.poster_path ? `${TMDB_IMAGE_BASE_URL}${media.poster_path}` : `https://placehold.co/500x750/374151/d1d5db?text=${currentLang.noPoster}`; // Added null check
                if (document.getElementById('detail-title')) document.getElementById('detail-title').textContent = media.title || media.name || currentLang.notAvailable; // Added null check
                if (document.getElementById('detail-genre')) document.getElementById('detail-genre').textContent = media.genres.map(g => g.name).join(', ') || currentLang.notAvailable; // Added null check
                if (document.getElementById('detail-rating')) document.getElementById('detail-rating').innerHTML = `‚≠ê ${media.vote_average ? media.vote_average.toFixed(1) : currentLang.notAvailable} / 10`; // Added null check
                
                // Populate new detail fields
                if (detailYear) detailYear.textContent = currentLang.productionYearPrefix + (media.release_date ? media.release_date.substring(0, 4) : (media.first_air_date ? media.first_air_date.substring(0, 4) : currentLang.notAvailable)); // Added null check
                if (detailAka) detailAka.textContent = currentLang.akaPrefix + alternativeTitles; // Added null check
                if (detailAgeRating) detailAgeRating.textContent = currentLang.ageRatingPrefix + ageRating; // Added null check
                if (detailDirector) detailDirector.textContent = currentLang.directorPrefix + director; // Added null check

                if (document.getElementById('detail-cast')) document.getElementById('detail-cast').textContent = currentLang.castPrefix + (cast || currentLang.notAvailable); // Added null check
                if (document.getElementById('detail-plot')) document.getElementById('detail-plot').textContent = media.overview || currentLang.plotNotAvailable; // Added null check
                if (document.getElementById('detail-trailer')) document.getElementById('detail-trailer').src = trailerUrl; // Added null check

                // Dynamically load top-rated movies for Layer 2
                console.log('Calling fetchAndDisplayTopRatedMovies for Layer 2 from fetchAndDisplayMediaDetail');
                await fetchAndDisplayTopRatedMovies('top-rated-movie-grid-layer2'); // Await this call to ensure it completes before resetting flag

            } catch (error) {
                console.error('Error fetching media details:', error);
                showMessageBox('errorTitle', 'failedToLoadDetails');
                // Optionally, go back to layer 1 on error
                showLayer(layer1);
                window.location.hash = ''; // Clear hash on error
            } finally {
                if (loadingSpinnerLayer2) loadingSpinnerLayer2.classList.add('hidden'); // Added null check
                if (document.getElementById('movie-detail-content')) document.getElementById('movie-detail-content').classList.remove('hidden'); // Added null check
                isFetchingDetail = false; // Reset flag after fetch completes (or fails)
            }
        }

        // Function to initialize genre buttons
        async function initializeGenreButtons() {
            // Clear all existing genre buttons
            if (genreButtonsContainer) { // Add null check
                genreButtonsContainer.innerHTML = '';
            }
            const currentLangCode = 'en'; // Hardcoded to English
            const currentLang = translations[currentLangCode];

            // Add "All" button first
            const allButton = document.createElement('button');
            allButton.textContent = currentLang.genres.All; // Use translated "All"
            allButton.className = 'genre-button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 whitespace-nowrap text-sm md:text-base';
            allButton.dataset.genreId = 'all';
            allButton.dataset.mediaType = 'movie';
            if (allButton) { // Add null check
                allButton.addEventListener('click', () => {
                    currentSearchQuery = '';
                    if (searchInput) searchInput.value = ''; // Add null check
                    currentGenreId = null; // No genre filter
                    fetchAndDisplayMedia('movie', 1, '', currentGenreId);
                    showLayer(layer1);
                    // Highlight "All" button
                    document.querySelectorAll('.genre-button').forEach(btn => {
                        btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'text-white');
                        btn.classList.add('bg-gray-700', 'hover:bg-gray-600', 'text-gray-200');
                    });
                    allButton.classList.remove('bg-gray-700', 'hover:bg-gray-600', 'text-gray-200');
                    allButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'text-white');
                });
            }
            if (genreButtonsContainer) { // Add null check
                genreButtonsContainer.appendChild(allButton);
            }

            // Create genre buttons from fixedMovieGenres
            for (const genreKey in fixedMovieGenres) {
                const genreId = fixedMovieGenres[genreKey];
                const button = document.createElement('button');
                // Use translated genre name
                button.textContent = currentLang.genres[genreKey] || genreKey; 
                // Default styling, will be shown/hidden based on currentMediaType
                button.className = 'genre-button bg-gray-700 hover:bg-green-600 text-gray-200 font-medium py-2 px-4 rounded-md shadow-sm transition-all duration-200 whitespace-nowrap text-sm md:text-base';
                button.dataset.genreId = genreId;
                button.dataset.mediaType = 'movie'; // Set media type to 'movie' for these genres

                if (button) { // Add null check
                    button.addEventListener('click', () => {
                        currentSearchQuery = '';
                        if (searchInput) searchInput.value = ''; // Add null check
                        currentGenreId = genreId;
                        fetchAndDisplayMedia('movie', 1, '', currentGenreId); // Ensure this filters movies
                        showLayer(layer1);
                        // Highlight active genre button
                        document.querySelectorAll('.genre-button').forEach(btn => {
                            btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'text-white');
                            btn.classList.add('bg-gray-700', 'hover:bg-gray-600', 'text-gray-200');
                        });
                        button.classList.remove('bg-gray-700', 'hover:bg-gray-600', 'text-gray-200');
                        button.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'text-white');
                    });
                }
                if (genreButtonsContainer) { // Add null check
                    genreButtonsContainer.appendChild(button);
                }
            }
        }

        // Function to handle URL hash changes
        async function handleHashChange() {
            const hash = window.location.hash;
            const currentLang = translations['en']; // Hardcoded to English

            if (hash.startsWith('#/media/')) {
                const parts = hash.split('/');
                if (parts.length >= 4) { // e.g., #/media/movie/123/title-slug
                    const type = parts[2];
                    const id = parts[3];
                    // The slug (parts[4]) is optional for loading, but good for SEO.

                    if ((type === 'movie' || type === 'tv') && !isNaN(id)) {
                        currentMediaId = id;
                        currentMediaType = type;
                        // Hide genre buttons when viewing details
                        document.querySelectorAll('.genre-button').forEach(button => {
                            button.style.display = 'none';
                        });
                        await fetchAndDisplayMediaDetail(id, type);
                    } else {
                        // Invalid hash, revert to home
                        console.warn(currentLang.invalidMediaHash);
                        fetchAndDisplayMedia('movie');
                        showLayer(layer1);
                        window.location.hash = ''; // Clear hash
                    }
                }
            } else if (hash === '#/home') { // Handle direct link to home page
                showLayer(layer4);
                document.querySelectorAll('.genre-button').forEach(button => {
                    button.style.display = 'none';
                });
            }
            else {
                // If no specific hash, or unrecognized hash, show popular movies
                fetchAndDisplayMedia('movie');
                showLayer(layer1);
                // No need to clear hash if it's already empty or handled
            }
        }

        // Event Listeners
        if (loadMoreButton) { // Add null check
            loadMoreButton.addEventListener('click', () => {
                fetchAndDisplayMedia(currentMediaType, currentPage + 1, currentSearchQuery, currentGenreId);
            });
        }

        if (backToListButton) { // Add null check
            backToListButton.addEventListener('click', () => {
                showLayer(layer1);
                window.location.hash = ''; // Clear hash when going back to list
                // Restore visibility of genre buttons based on currentMediaType
                document.querySelectorAll('.genre-button').forEach(button => {
                    if (button.dataset.mediaType === currentMediaType) {
                        button.style.display = 'inline-block';
                    } else {
                        button.style.display = 'none';
                    }
                });
            });
        }

        if (backToDetailButton) { // Add null check
            backToDetailButton.addEventListener('click', () => {
                showLayer(layer2);
                // Stop streaming when going back to details
                if (document.getElementById('streaming-player')) document.getElementById('streaming-player').src = ''; // Added null check
                if (document.getElementById('streaming-player-container')) { // Added null check
                    document.getElementById('streaming-player-container').classList.add('hidden');
                }
                // No need to change hash here, as we are navigating within the detail view context
            });
        }

        if (backFromHomeButton) { // Add null check
            backFromHomeButton.addEventListener('click', () => { // Added event listener for backFromHomeButton
                currentSearchQuery = ''; // Clear any search
                if (searchInput) searchInput.value = ''; // Clear search input // Added null check
                currentGenreId = null; // Clear genre filter
                fetchAndDisplayMedia('movie', 1); // Load popular movies
                // showLayer(layer1); // This will be called by fetchAndDisplayMedia, but explicitly here for clarity
                window.location.hash = ''; // Clear hash when going back from home
                // Restore visibility of genre buttons based on currentMediaType
                document.querySelectorAll('.genre-button').forEach(button => {
                    if (button.dataset.mediaType === currentMediaType) {
                        button.style.display = 'inline-block';
                    } else {
                        button.style.display = 'none';
                    }
                });
            });
        }

        /**
         * Handles the streaming button click for all stream buttons.
         * Opens an Adsterra ad on the first click for a given media ID,
         * then proceeds to load the streaming player on subsequent clicks.
         * @param {string} streamButtonId - The ID of the clicked stream button (e.g., 'stream-1-button').
         */
        function handleStreamButtonClick(streamButtonId) {
            const currentLang = translations['en']; // Hardcoded to English

            if (!currentMediaId) {
                showMessageBox('errorTitle', 'noMediaSelected');
                return;
            }

            let streamingUrl = '';
            let adTriggeringSource = ''; 

            switch (streamButtonId) {
                case 'stream-1-button':
                    streamingUrl = `https://vidsrc.me/embed/${currentMediaId}`;
                    adTriggeringSource = 'vidsrc.me';
                    break;
                case 'stream-2-button':
                    if (!currentImdbId) {
                        showMessageBox('errorTitle', 'imdbIdNotAvailable');
                        return;
                    }
                    streamingUrl = `https://vidsrc.to/embed/${currentMediaType === 'movie' ? 'movie' : 'tv'}?imdb=${currentImdbId}`;
                    adTriggeringSource = 'vidsrc.to';
                    break;
                case 'stream-3-button':
                    streamingUrl = `https://vidsrc.me/embed/${currentMediaId}`;
                    adTriggeringSource = 'vidsrc.me-direct'; // Identifier for Stream 3
                    break;
                case 'stream-4-button':
                    if (!currentImdbId) {
                        showMessageBox('errorTitle', 'imdbIdNotAvailable');
                        return;
                    }
                    streamingUrl = `https://vidsrc.to/embed/${currentMediaType === 'movie' ? 'movie' : 'tv'}?imdb=${currentImdbId}`;
                    adTriggeringSource = 'vidsrc.to-direct'; // Identifier for Stream 4
                    break;
                default:
                    console.error('Unknown stream button ID:', streamButtonId);
                    return;
            }

            // Adsterra Direct Ad Logic: Open ad on first click for this mediaId
            // The adTriggeredMediaIds set tracks per media ID, not per button, which is good.
            if (!adTriggeredMediaIds.has(currentMediaId)) {
                window.open(getRandomAdLink(), '_blank'); // Menggunakan tautan acak
                adTriggeredMediaIds.add(currentMediaId); // Mark as triggered
                console.log(`Adsterra ad triggered for stream button: ${streamButtonId} for media ID: ${currentMediaId}`);
                // Prevent streaming player from loading on first click
                return;
            }

            // If ad has been triggered (subsequent click), proceed to load streaming player
            showLayer(layer3);
            if (document.getElementById('streaming-player-container')) { // Added null check
                document.getElementById('streaming-player-container').classList.add('hidden');
            }
            if (loadingSpinnerLayer3) { // Added null check
                loadingSpinnerLayer3.classList.remove('hidden');
            }

            if (document.getElementById('streaming-player')) { // Added null check
                document.getElementById('streaming-player').src = streamingUrl;
                document.getElementById('streaming-player').onload = () => {
                    if (loadingSpinnerLayer3) loadingSpinnerLayer3.classList.add('hidden'); // Added null check
                    if (document.getElementById('streaming-player-container')) document.getElementById('streaming-player-container').classList.remove('hidden'); // Added null check
                };
            }
            // Fallback to hide spinner after a delay if onload event doesn't fire for some reason
            setTimeout(() => {
                if (loadingSpinnerLayer3) loadingSpinnerLayer3.classList.add('hidden'); // Added null check
                if (document.getElementById('streaming-player-container')) document.getElementById('streaming-player-container').classList.remove('hidden'); // Added null check
            }, 3000); // 3-second delay
            console.log(`Streaming player loaded for media ID: ${currentMediaId} from ${adTriggeringSource}`);
        }

        // Update event listeners to call the unified function
        if (stream1Button) stream1Button.addEventListener('click', () => handleStreamButtonClick('stream-1-button'));
        if (stream2Button) stream2Button.addEventListener('click', () => handleStreamButtonClick('stream-2-button'));
        if (stream3Button) stream3Button.addEventListener('click', () => handleStreamButtonClick('stream-3-button'));
        if (stream4Button) stream4Button.addEventListener('click', () => handleStreamButtonClick('stream-4-button'));

        if (whyWatchButton) { // Added null check
            whyWatchButton.addEventListener('click', async () => {
                const mediaPlot = document.getElementById('detail-plot').textContent;
                const mediaTitle = document.getElementById('detail-title').textContent;
                const currentLangCode = 'en'; // Hardcoded to English
                const currentLang = translations[currentLangCode];
                const mediaTypeName = currentMediaType === 'movie' ? currentLang.moviesButton.toLowerCase() : currentLang.tvSeriesButton.toLowerCase(); // Using translation for media type name

                if (!mediaPlot || mediaPlot === currentLang.plotNotAvailable) {
                    showMessageBox('infoTitle', 'noPlotForInsight', { mediaTypeName: mediaTypeName });
                    return;
                }

                if (whyWatchOutput) whyWatchOutput.classList.remove('hidden'); // Added null check
                if (whyWatchText) whyWatchText.textContent = ''; // Clear previous text // Added null check
                if (whyWatchSpinner) whyWatchSpinner.classList.remove('hidden'); // Show spinner // Added null check

                try {
                    let chatHistory = [];
                    // Prompt LLM in English for best results, then translate on frontend if needed
                    const llmPrompt = `Based on the following plot summary, write a compelling, 3-sentence reason why someone should watch this ${currentMediaType === 'movie' ? 'movie' : 'TV series'} titled "${mediaTitle}". Focus on intrigue, emotional depth, or unique elements. Plot: "${mediaPlot}"`;
                    chatHistory.push({ role: "user", parts: [{ text: llmPrompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const generatedText = result.candidates[0].content.parts[0].text;
                        if (whyWatchText) whyWatchText.textContent = generatedText; // Display raw text from LLM // Added null check
                        // If LLM translation is needed, do it here:
                        // const translatedText = await translateText(generatedText, currentLangCode);
                        // if (whyWatchText) whyWatchText.textContent = translatedText;
                    } else {
                        if (whyWatchText) whyWatchText.textContent = currentLang.llmNoInsight; // Added null check
                        console.error('Unexpected LLM response structure:', result);
                    }
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    if (whyWatchText) whyWatchText.textContent = currentLang.llmApiError; // Added null check
                } finally {
                    if (whyWatchSpinner) whyWatchSpinner.classList.add('hidden'); // Hide spinner // Added null check
                }
            });
        }


        if (searchButton) { // Added null check
            searchButton.addEventListener('click', () => {
                const query = searchInput.value.trim();
                const currentLang = translations['en']; // Hardcoded to English
                if (query) {
                    currentGenreId = null; // Clear genre filter
                    currentSearchQuery = query;
                    fetchAndDisplayMedia(currentMediaType, 1, query); // Start new search from page 1
                } else {
                    currentSearchQuery = '';
                    // If search input is empty, revert to popular media or current genre
                    fetchAndDisplayMedia(currentMediaType, 1, '', currentGenreId);
                }
            });
        }

        if (searchInput) { // Added null check
            searchInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    if (searchButton) searchButton.click(); // Added null check
                }
            });
        }

        // Initial load when window loads
        window.onload = () => {
            initializeGenreButtons(); // Create genre buttons first
            // Set current year in footer
            const currentYearElement = document.getElementById('current-year');
            if (currentYearElement) { // Added null check
                currentYearElement.textContent = new Date().getFullYear();
            }
            
            // Load saved language or default to English
            const savedLang = localStorage.getItem('siyatniLang') || 'en';
            setLanguage(savedLang);

            handleHashChange(); // Call on load to handle deep linking
        };

        // Add event listener for hash changes
        window.addEventListener('hashchange', handleHashChange);


        // Handle navigation buttons (Movies/TV Series)
        if (navMoviesButton) { // Added null check
            navMoviesButton.addEventListener('click', () => {
                currentSearchQuery = ''; // Clear search
                if (searchInput) searchInput.value = ''; // Clear search input // Added null check
                currentGenreId = null; // Clear genre filter
                // Show movie genre buttons again
                document.querySelectorAll('.genre-button').forEach(button => {
                    if (button.dataset.mediaType === 'movie') { // Only show movie genre buttons
                        button.style.display = 'inline-block';
                    }
                });
                fetchAndDisplayMedia('movie', 1); // Reload popular movies
                showLayer(layer1);
                window.location.hash = ''; // Clear hash when going back to movies home
            });
        }

        if (navTvSeriesButton) { // Added null check
            navTvSeriesButton.addEventListener('click', () => {
                currentSearchQuery = ''; // Clear search
                if (searchInput) searchInput.value = ''; // Clear search input // Added null check
                currentGenreId = null; // Clear genre filter
                // Hide all genre buttons when switching to TV series (as these genres are only for movies)
                document.querySelectorAll('.genre-button').forEach(button => {
                    button.style.display = 'none';
                });
                fetchAndDisplayMedia('tv', 1); // Load popular TV series
                showLayer(layer1);
                window.location.hash = ''; // Clear hash when going back to TV series home
            });
        }

        // New event listener for the Home button
        if (navHomeButton) { // Added null check
            navHomeButton.addEventListener('click', () => {
                showLayer(layer4); // Show layer 4
                window.location.hash = '#/home'; // Set hash for home page
                // Hide genre buttons when viewing home page
                document.querySelectorAll('.genre-button').forEach(button => {
                    button.style.display = 'none';
                });
            });
        }

        // Event delegation for static movie cards in Layer 2, Layer 3, and now Layer 4
        // This listener is attached to the document body and will catch clicks on .static-movie-card elements
        // even if they are added to the DOM dynamically or their display property changes.
        document.body.addEventListener('click', (event) => {
            const clickedCard = event.target.closest('.static-movie-card');
            if (clickedCard) {
                const mediaId = clickedCard.dataset.mediaId;
                const mediaType = clickedCard.dataset.mediaType;
                const mediaTitle = clickedCard.querySelector('h3').textContent; // Get title for slug
                
                // Only proceed if mediaType is 'movie' or 'tv'
                if ((mediaType === 'movie' || mediaType === 'tv') && mediaId) {
                    if (!staticAdTriggeredMediaIds.has(mediaId)) {
                        // First click: Open ad
                        window.open(getRandomAdLink(), '_blank'); // Menggunakan tautan acak
                        staticAdTriggeredMediaIds.add(mediaId); // Mark as triggered
                        console.log(`Adsterra ad triggered for static card: ${mediaTitle}`);
                    } else {
                        // Subsequent click: Navigate to details
                        currentMediaId = mediaId;
                        fetchAndDisplayMediaDetail(mediaId, mediaType, mediaTitle);
                        console.log(`Navigating to details for static card: ${mediaTitle}`);
                    }
                } else if (mediaType === 'site') {
                    console.log('Clicked on site card, not fetching TMDB details.');
                }
            }
        });
        // Added a harmless comment to ensure the script ends cleanly.
    </script>
</body>
</html>